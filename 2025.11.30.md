## ğŸ“Œ DualPath Adapter í›ˆë ¨Â·í…ŒìŠ¤íŠ¸ ì„¸íŒ… ì •ë¦¬ (ì—…ë°ì´íŠ¸ ê³µìœ )

ì´ë²ˆì— 3DSAMì˜ Adapter í•™ìŠµ êµ¬ì¡°ë¥¼ ì •ë¦¬í•˜ê³ , DualPath Adapter ì‹¤í—˜ í™˜ê²½ì„ ìƒˆë¡œ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.
ì•„ë˜ëŠ” í˜„ì¬ ê¸°ì¤€ìœ¼ë¡œ í†µì¼ëœ í•™ìŠµ/í…ŒìŠ¤íŠ¸ ë°©ë²•ê³¼ ì§ì ‘ ë³€ê²½í•œ í•µì‹¬ êµ¬ì¡° ì •ë¦¬ì…ë‹ˆë‹¤.
ì´ë²ˆì— í•™ìŠµ êµ¬ì¡°ë¥¼ â€œì–´ëŒ‘í„° ê¸°ë°˜ Fine-Tuningâ€ìœ¼ë¡œ ì™„ì „íˆ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤.

---

## â„ï¸ Frozen (í•™ìŠµ ì•ˆ í•˜ëŠ” ë¶€ë¶„)
- Image Encoder ëŒ€ë¶€ë¶„
- Patch embedding, Positional embedding
- Attention(QKV), MLP ì „ë¶€ Freeze
- Prompt Encoder ì „ì²´ Freeze
- Mask Decoder ì „ì²´ Freeze

**â†’ Pretrained weightë§Œ ì‚¬ìš©í•˜ê³ , Gradient ì—…ë°ì´íŠ¸ ì—†ìŒ**

## âœ… Active (ì‹¤ì œë¡œ í•™ìŠµë˜ëŠ” ë¶€ë¶„)

Image Encoder ë‚´ë¶€ì—ì„œ ì•„ë˜ë§Œ í•™ìŠµë©ë‹ˆë‹¤.
- depth_embed
- slice_embed
- ê° blockì˜ norm1, norm2
- blocks[i].adapter (DualPath Adapter ì „ì²´)
- Depth relative position embedding
- neck_3d (3D neck layer)

ì¦‰, ì‹¤ì œ í•™ìŠµì€ â€œì–´ëŒ‘í„° + ì¼ë¶€ 3D ê´€ë ¨ ëª¨ë“ˆë§Œâ€ ì§„í–‰ë©ë‹ˆë‹¤.

---

## 5ï¸âƒ£ DualPath Adapter ë‚´ë¶€ í•™ìŠµ íŒŒë¼ë¯¸í„°

1. ê³µí†µ ì¸ì½”ë”©
- linear1 (input_dim â†’ mid_dim)

2. Global 3D Context Path
- global_conv (3Ã—3Ã—3 depthwise 3D conv)

3. Local UNet++ Path
- conv_0_0, conv_1_0, conv_0_1
- ë‚´ë¶€ êµ¬ì„±:
  - depthwise conv (1Ã—3Ã—3)
  - pointwise conv (1Ã—1Ã—1)
  - InstanceNorm3d
  - ReLU

4. Fusion Gate
- 1Ã—1Ã—1 conv ê¸°ë°˜ gate

5. Output Projection
- linear2 (mid_dim â†’ input_dim)

---

## 6ï¸âƒ£ Optimizer / Scheduler / Loss ì„¸íŒ…

### âœ… Optimizer
- Encoderìš© AdamW 1ê°œë§Œ ì‚¬ìš©
- Learning Rate: 4e-4
- Weight Decay: 0
- Prompt Encoder, Mask Decoder optimizer ì™„ì „ ì œê±°

### âœ… Scheduler
- LinearLR
- start_factor = 1.0
- end_factor = 0.01
- Total Iter = max_epoch (500)

### âœ… Loss
- Train: Dice + CE (0.5 / 0.5)
- Validation: Dice Loss

### âœ… Gradient Clipping
- Adapter íŒŒë¼ë¯¸í„°ì—ë§Œ ì ìš©
- max_norm = 1.0

---

## 7ï¸âƒ£ Original Adapter vs DualPath Adapter ì‹¤í—˜ êµ¬ì„±

Originalì—ì„œ ê¸°ì¡´ì— í•™ìŠµëœ ì–´ëŒ‘í„°ë¥¼ **ë¡œë“œë§Œ í•´ì„œ validation ìˆ˜í–‰**í•˜ë„ë¡ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

python train.py \
    --data kits \
    --data_prefix "dataset/kits" \
    --snapshot_path "../experiments/kits_original" \
    --rand_crop_size 128 \
    --adapter_type original \
    --pretrained_adapter_path "../experiments/kits/best.pth.tar" \
    --max_epoch 500 \
    --lr 4e-4

- í•™ìŠµ ì‹œê°„ 0
- ê¸°ì¡´ ì„±ëŠ¥ ê·¸ëŒ€ë¡œ ë¹„êµ ê°€ëŠ¥

---

## 8ï¸âƒ£ êµ¬ì¡° ë³€ê²½ìœ¼ë¡œ ê¸°ëŒ€í•˜ëŠ” íš¨ê³¼

### âœ… í•™ìŠµ ì†ë„ ê°œì„ 
- í•™ìŠµ íŒŒë¼ë¯¸í„° ìˆ˜ ì•½ 70~80% ê°ì†Œ
- Optimizer 3ê°œ â†’ 1ê°œ

### âœ… GPU ë©”ëª¨ë¦¬ ê°ì†Œ
- Prompt / Decoder gradient ì œê±°
- Optimizer state ê°ì†Œ

### âœ… DualPath êµ¬ì¡°ì  ì´ì 
- Global Path â†’ ì „ì—­ 3D í˜•íƒœ ì •ë³´
- Local UNet++ Path â†’ ê²½ê³„/í…ìŠ¤ì²˜ ì •ë³´

ì„¸ë¶€ ì½”ë“œëŠ” ëª¨ë¸ì´ ëŒì•„ê°€ëŠ” ì¤‘ì´ë¼ ì»´í“¨í„° ë©ˆì¶¤ í˜„ìƒì´ ë„ˆë¬´ ì‹¬í•´ì„œ ë‚˜ì¤‘ì— ê³µìœ í•˜ê² ìŠµë‹ˆë‹¤.
